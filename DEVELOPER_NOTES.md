# Developer Notes - TonyStack

## CRITICAL RULES - READ BEFORE ANY CHANGES

### Database & Migrations

**NEVER manually edit migration files!**

#### Workflow for Schema Changes

1. **Edit the model file** (e.g., `src/auth/user.model.ts`)
2. **Generate migration** using Drizzle Kit:

   ```bash
   deno task migrate:generate
   ```

3. **Review the generated SQL** in `migrations/`
4. **Run migration** to apply:

   ```bash
   # Development
   deno task migrate:run

   # Test database
   ENVIRONMENT=test deno task migrate:run
   ```

#### If Schema and Migration are Out of Sync

```bash
# Delete all migrations
rm -rf migrations/*

# Regenerate from current schema
deno task migrate:generate

# Apply to databases
deno task migrate:run
ENVIRONMENT=test deno task migrate:run
```

**Common Issues:**

- [ERROR] Manually editing migration SQL files
- [ERROR] Forgetting to generate migrations after model changes
- [ERROR] Running old migrations with new schema
- [SUCCESS] Always use Drizzle Kit to generate migrations
- [SUCCESS] Keep schema models as single source of truth

---

## Project Structure

### Database Files

```text
packages/starter/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ user.model.ts          [SUCCESS] User schema (NOT in entities!)
â”‚   â”‚   â”œâ”€â”€ auth-token.model.ts    [SUCCESS] Auth token schema
â”‚   â”‚   â””â”€â”€ auth.*.ts              [SUCCESS] Auth logic
â”‚   â””â”€â”€ entities/
â”‚       â””â”€â”€ articles/              [SUCCESS] Example entity
â”‚           â”œâ”€â”€ article.model.ts   [SUCCESS] Article schema
â”‚           â”œâ”€â”€ article.*.ts       [SUCCESS] Controller, service, routes
â”‚           â””â”€â”€ article.test.ts    [SUCCESS] Tests with auth
â”œâ”€â”€ migrations/                     [SUCCESS] Generated SQL (DO NOT EDIT!)
â”‚   â””â”€â”€ 0000_*.sql
â””â”€â”€ scripts/
    â”œâ”€â”€ create-db.ts               [SUCCESS] Database creation
    â”œâ”€â”€ seed-*.ts                  [SUCCESS] Seeding scripts
    â””â”€â”€ setup-test-db.ts           [SUCCESS] Test database setup
```

**Key Points:**

- **Auth models** live in `src/auth/` NOT `src/entities/users/`
- **Migrations** are in `migrations/` and managed by Drizzle Kit
- **SQLite files** (data/*.db) are NOT used - we use PostgreSQL

---

## Testing

### Test Database Setup

**Before running tests:**

```bash
# Setup and migrate test database
ENVIRONMENT=test deno task test:setup
ENVIRONMENT=test deno task migrate:run

# Seed test users
ENVIRONMENT=test deno task db:seed
```

### Test File Patterns

#### Scaffolded Entity Tests

Generated by `tstack scaffold <entity>`:

- Basic CRUD operations
- No authentication required
- Public endpoints

#### Auth-Protected Entity Tests

Like `article.test.ts`:

- Login steps to get tokens
- Protected routes (POST/PUT/DELETE)
- Authorization checks (ownership)
- Public GET routes

**Template location:** `packages/cli/src/templates/test.ts`

---

## Common Issues & Solutions

### Issue: "column 'role' does not exist"

**Cause:** Migration missing the column\
**Solution:** Regenerate migrations from schema

### Issue: "relation 'articles' does not exist"

**Cause:** Migrations not run on test database\
**Solution:** `ENVIRONMENT=test deno task migrate:run`

### Issue: Empty model files

**Cause:** Accidental scaffolding or file creation\
**Solution:** Check if model exists elsewhere, delete duplicate

### Issue: SQLite references remain

**Cause:** Old configuration from SQLite days\
**Solution:**

- Remove `data/` folder
- Update `.gitignore` to remove SQLite patterns
- Use PostgreSQL only

---

## Emoji Removal Completed [OK]

**Date:** October 31, 2025\
**Commit:** Removed 200+ emojis from codebase\
**Standard:** See `CODING_STANDARDS.md`

**Replaced:**

- `[SUCCESS]` â†’ `[SUCCESS]`
- `[OK]` â†’ `[OK]`
- `[ERROR]` â†’ `[ERROR]`
- `[WARNING]` â†’ `[WARNING]`
- `` `ðŸŒ±` `` â†’ removed or replaced with `[SEED]` `[TIP]`

**Rule:** NO emojis in code, logs, or console output. Ever.

---

## Migration History

### Current State (as of Oct 31, 2025)

**Active Migration:**

- `0000_square_phalanx.sql` - Initial schema with articles, auth_tokens, users
  (including role column)

**What it creates:**

- `articles` table (9 columns, author_id FK to users)
- `auth_tokens` table (9 columns, user_id FK to users)
- `users` table (11 columns including role)

**All tables have:**

- `id` (auto-increment)
- `created_at` (timestamp)
- `updated_at` (timestamp)
- Entity-specific columns

---

## Deleted/Removed

- [ERROR] `data/dev.db` - Old SQLite database
- [ERROR] `data/` folder - Not needed for PostgreSQL
- [ERROR] `src/entities/users/` - Empty duplicate folder
- [ERROR] `migrations/0000_lying_callisto.sql` - Old migration without role
  column
- [ERROR] `migrations/0001_adorable_jasper_sitwell.sql` - ALTER TABLE for role
  (not needed after regeneration)

---

## Maintenance Checklist

### Before Committing

- [ ] Run `deno fmt` to format code
- [ ] Check no emojis in code: `grep -r "[SUCCESS]\|[ERROR]\|" packages/`
- [ ] Verify migrations match schema
- [ ] Test database setup works: `ENVIRONMENT=test deno task test:reset`
- [ ] Run tests: `deno task test`

### Adding New Entity

1. Use scaffold: `tstack scaffold <entity-name>`
2. Migrations auto-generated - review them
3. Run migration: `deno task migrate:run`
4. Update test data in generated test file
5. Add authentication if needed (see article.test.ts example)

### Schema Changes

1. Edit model file (*.model.ts)
2. Generate migration: `deno task migrate:generate`
3. Review generated SQL in migrations/
4. Run on dev: `deno task migrate:run`
5. Run on test: `ENVIRONMENT=test deno task migrate:run`
6. Update seed scripts if schema changes affect them

---

## Future Development Notes

### Starter Kit Improvements Needed

1. **Migration Management**
   - Add warning comment at top of generated migrations: "DO NOT EDIT MANUALLY"
   - Consider migration rollback scripts
   - Document migration workflow in starter README

2. **Test Database**
   - Automate test db setup in test runner
   - Consider using separate test database per test run
   - Add cleanup between test runs

3. **Authentication**
   - User model is in `auth/` not `entities/` - document this clearly
   - Test templates should have auth variant option
   - RBAC implementation needed (currently placeholder)

4. **Scaffolding**
   - When scaffolding entities, check if auth is needed
   - Offer choice between public/protected routes
   - Generate appropriate test file (with/without auth)

5. **Documentation**
   - Add migration workflow to README
   - Document test database setup
   - Show examples of auth-protected vs public entities
   - Explain why users are in auth/ not entities/

---

## Remember

- **Schema models are the source of truth**
- **Drizzle Kit generates migrations**
- **Never edit migration SQL manually**
- **Test database needs separate migrations**
- **No emojis. Ever. Seriously.**
- **User model is in auth/, not entities/**

---

## Docker Deployment

### Files

- `Dockerfile` - Application container (PostgreSQL ready, NO SQLite)
- `docker-compose.yml` - Full stack (app + postgres)
- `.dockerignore` - Excludes unnecessary files from build
- `.env.docker` - Environment template for Docker

### Key Changes from SQLite

- [ERROR] Removed `RUN mkdir -p data` (no SQLite)
- [SUCCESS] Uses PostgreSQL via DATABASE_URL
- [SUCCESS] Healthcheck uses /health endpoint
- [SUCCESS] App waits for postgres to be healthy

### Usage

**Development (database only):**

```bash
docker compose up postgres -d
# Use local Deno for development
deno task dev
```

**Full production stack:**

```bash
# Copy environment template
cp .env.docker .env
# Edit .env with production values

# Start everything
docker compose up --build -d

# Run migrations
docker compose exec app deno task migrate:run

# Seed database
docker compose exec app deno task db:seed
```

**View logs:**

```bash
docker compose logs -f app
docker compose logs -f postgres
```

**Reset everything:**

```bash
docker compose down -v  # Warning: deletes database!
```

---

## Quick Commands Reference

```bash
# Development
deno task dev              # Start dev server
deno task migrate:generate # Generate migration from schema
deno task migrate:run      # Apply migrations
deno task db:seed          # Seed database

# Testing
ENVIRONMENT=test deno task test:reset    # Reset test database
ENVIRONMENT=test deno task migrate:run   # Migrate test database
deno task test                        # Run all tests

# Database
deno task db:create        # Create PostgreSQL database
deno task db:studio        # Open Drizzle Studio (GUI)

# Docker
docker compose up -d                        # Start full stack
docker compose up postgres -d               # Database only
docker compose exec app deno task migrate:run  # Run migrations
docker compose exec app deno task db:seed   # Seed database
docker compose logs -f app                  # View app logs
docker compose down                         # Stop services
docker compose down -v                      # Stop + delete data

# Code Quality
deno fmt                   # Format code
deno lint                  # Lint code
grep -r "[SUCCESS]\|[ERROR]\|" .     # Check for emojis
```

---

**Last Updated:** October 31, 2025\
**Project:** TonyStack v1.0\
**Branch:** feature/auth-system
